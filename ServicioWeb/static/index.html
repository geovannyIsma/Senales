<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnSignals XR - Panel de Instructor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #5231F0;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #7c5ce0);
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-card .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-card .stat-label {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(82, 49, 240, 0.05);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #4125c0;
            border-color: #4125c0;
        }
        
        .badge-baja { background-color: var(--success-color); }
        .badge-media { background-color: var(--warning-color); color: #000; }
        .badge-alta { background-color: var(--danger-color); }
        
        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .error-message {
            display: none;
            color: var(--danger-color);
            padding: 20px;
            text-align: center;
        }
        
        .error-message.active {
            display: block;
        }
        
        .metric-highlight {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .config-input {
            max-width: 120px;
        }
        
        .validation-error {
            border-color: var(--danger-color) !important;
        }
        
        .validation-message {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-signpost-2"></i> LearnSignals XR
            </a>
            <span class="navbar-text text-white">
                Panel de Instructor
            </span>
        </div>
    </nav>

    <div class="container">
        <!-- Tabs de navegación -->
        <ul class="nav nav-pills mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" 
                        data-bs-target="#dashboard" type="button">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sesiones-tab" data-bs-toggle="pill" 
                        data-bs-target="#sesiones" type="button">
                    <i class="bi bi-journal-text"></i> Sesiones
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="configuracion-tab" data-bs-toggle="pill" 
                        data-bs-target="#configuracion" type="button">
                    <i class="bi bi-gear"></i> Configuración
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Tab: Dashboard -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="stat-estudiantes">-</div>
                            <div class="stat-label">Estudiantes</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="stat-sesiones">-</div>
                            <div class="stat-label">Sesiones Totales</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="stat-completadas">-</div>
                            <div class="stat-label">Completadas</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="stat-tiempo">-</div>
                            <div class="stat-label">Tiempo Prom. (s)</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5><i class="bi bi-bar-chart"></i> Rendimiento Promedio</h5>
                            <canvas id="chartRendimiento" height="200"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5><i class="bi bi-exclamation-triangle"></i> Errores Más Comunes</h5>
                            <canvas id="chartErrores" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Sesiones -->
            <div class="tab-pane fade" id="sesiones" role="tabpanel">
                <div class="card p-3 mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label">Filtrar por estudiante:</label>
                            <select class="form-select" id="filtroEstudiante">
                                <option value="">Todos los estudiantes</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Estado:</label>
                            <select class="form-select" id="filtroEstado">
                                <option value="">Todas</option>
                                <option value="true">Completadas</option>
                                <option value="false">En progreso</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary" onclick="cargarSesiones()">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="loading" id="loadingSesiones">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Cargando sesiones...</p>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Estudiante</th>
                                    <th>Fecha</th>
                                    <th>Aciertos</th>
                                    <th>Errores</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaSesiones">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal de Métricas Detalladas -->
                <div class="modal fade" id="modalMetricas" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-graph-up"></i> Métricas de Sesión #<span id="metricaSesionId"></span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="modalMetricasBody">
                                <div class="loading active" id="loadingMetricas">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Cargando métricas...</p>
                                </div>
                                <div id="contenidoMetricas" style="display: none;"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" id="btnExportarJSON" disabled>
                                    <i class="bi bi-filetype-json"></i> Exportar JSON
                                </button>
                                <button type="button" class="btn btn-outline-success" id="btnExportarCSV" disabled>
                                    <i class="bi bi-filetype-csv"></i> Exportar CSV
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Configuración -->
            <div class="tab-pane fade" id="configuracion" role="tabpanel">
                <div class="card p-4">
                    <h5 class="mb-4"><i class="bi bi-sliders"></i> Parámetros de Evaluación</h5>
                    
                    <div class="loading" id="loadingConfig">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Cargando configuración...</p>
                    </div>

                    <form id="formConfiguracion" style="display: none;">
                        <!-- Cantidad de Señales -->
                        <h6 class="text-muted mt-3 mb-3">
                            <i class="bi bi-signpost"></i> Cantidad de Señales por Ronda
                        </h6>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">Dificultad Baja</label>
                                <input type="number" class="form-control config-input" 
                                       id="senales_baja" min="1" max="10" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Dificultad Media</label>
                                <input type="number" class="form-control config-input" 
                                       id="senales_media" min="1" max="15" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Dificultad Alta</label>
                                <input type="number" class="form-control config-input" 
                                       id="senales_alta" min="1" max="20" required>
                            </div>
                        </div>

                        <!-- Tiempos -->
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-stopwatch"></i> Tiempo para Responder (segundos)
                        </h6>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">Dificultad Baja</label>
                                <input type="number" class="form-control config-input" 
                                       id="tiempo_baja" min="1" max="30" step="0.5" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Dificultad Media</label>
                                <input type="number" class="form-control config-input" 
                                       id="tiempo_media" min="0.5" max="20" step="0.5" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Dificultad Alta</label>
                                <input type="number" class="form-control config-input" 
                                       id="tiempo_alta" min="0.5" max="15" step="0.5" required>
                            </div>
                        </div>

                        <!-- Configuración General -->
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-gear-wide"></i> Configuración General
                        </h6>
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Dificultad Inicial</label>
                                <select class="form-select" id="dificultad_inicial">
                                    <option value="0">Baja</option>
                                    <option value="1">Media</option>
                                    <option value="2">Alta</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Rondas por Zona (Máx)</label>
                                <input type="number" class="form-control config-input" 
                                       id="rondas_zona" min="1" max="20" required>
                                <small class="text-muted">Límite máximo de rondas</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Rondas Mínimas</label>
                                <input type="number" class="form-control config-input" 
                                       id="rondas_minimas" min="1" max="10" required>
                                <small class="text-muted">Mínimo antes de pasar zona</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tasa Aciertos Mínima</label>
                                <input type="number" class="form-control config-input" 
                                       id="tasa_minima" min="0.1" max="1" step="0.05" required>
                                <small class="text-muted">% para pasar de zona</small>
                            </div>
                        </div>

                        <!-- Configuración del Modelo ML -->
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-robot"></i> Modelo de Machine Learning
                        </h6>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="usar_ml" checked>
                                    <label class="form-check-label" for="usar_ml">
                                        <strong>Usar Modelo ML para ajustar dificultad</strong>
                                    </label>
                                </div>
                                <small class="text-muted">El modelo Random Forest predice la dificultad óptima</small>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">URL del Servidor ML</label>
                                <input type="text" class="form-control" 
                                       id="url_ml" placeholder="http://127.0.0.1:8000">
                                <small class="text-muted">Endpoint del servicio de predicción</small>
                            </div>
                        </div>

                        <!-- Estado del Modelo -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info" id="estadoML">
                                    <i class="bi bi-info-circle"></i> 
                                    <span id="textoEstadoML">Verificando conexión con el modelo...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Errores de validación -->
                        <div id="erroresValidacion" class="alert alert-danger" style="display: none;">
                            <strong>Errores de validación:</strong>
                            <ul id="listaErrores" class="mb-0"></ul>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> Guardar Cambios
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="cargarConfiguracion()">
                                <i class="bi bi-arrow-counterclockwise"></i> Restaurar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let chartRendimiento = null;
        let chartErrores = null;
        let sesionActual = null;

        // ============== INICIALIZACIÓN ==============
        document.addEventListener('DOMContentLoaded', () => {
            cargarEstadisticas();
            cargarEstudiantes();
            cargarSesiones();
            cargarConfiguracion();
            
            // Configurar formulario
            document.getElementById('formConfiguracion').addEventListener('submit', guardarConfiguracion);
            
            // Verificar ML cuando cambie la URL
            document.getElementById('url_ml').addEventListener('change', (e) => {
                verificarEstadoML(e.target.value);
            });
        });

        // ============== VERIFICACIÓN MODELO ML ==============
        async function verificarEstadoML(url) {
            const estadoDiv = document.getElementById('estadoML');
            const textoEstado = document.getElementById('textoEstadoML');
            
            try {
                const response = await fetch(url + '/', { 
                    method: 'GET',
                    timeout: 5000 
                });
                
                if (response.ok) {
                    const data = await response.json();
                    estadoDiv.className = 'alert alert-success';
                    textoEstado.innerHTML = `<strong>✅ Modelo ML Conectado</strong> - ${data.mensaje || 'Servicio activo'}`;
                } else {
                    throw new Error('Respuesta no OK');
                }
            } catch (error) {
                estadoDiv.className = 'alert alert-warning';
                textoEstado.innerHTML = `<strong>⚠️ Modelo ML No Disponible</strong> - El servidor no responde en ${url}. La dificultad no se ajustará automáticamente.`;
            }
        }

        // ============== DASHBOARD ==============
        async function cargarEstadisticas() {
            try {
                const response = await fetch(`${API_URL}/estadisticas`);
                const data = await response.json();
                
                document.getElementById('stat-estudiantes').textContent = data.total_estudiantes;
                document.getElementById('stat-sesiones').textContent = data.total_sesiones;
                document.getElementById('stat-completadas').textContent = data.sesiones_completadas;
                document.getElementById('stat-tiempo').textContent = data.promedio_tiempo_respuesta.toFixed(1);
                
                // Gráfico de rendimiento
                if (chartRendimiento) chartRendimiento.destroy();
                const ctx1 = document.getElementById('chartRendimiento').getContext('2d');
                chartRendimiento = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['Aciertos Promedio', 'Errores Promedio'],
                        datasets: [{
                            data: [data.promedio_aciertos, data.promedio_errores],
                            backgroundColor: ['#28a745', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                
                // Gráfico de errores comunes
                if (chartErrores) chartErrores.destroy();
                const ctx2 = document.getElementById('chartErrores').getContext('2d');
                chartErrores = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: data.errores_mas_comunes.map(e => e.senal),
                        datasets: [{
                            label: 'Cantidad de errores',
                            data: data.errores_mas_comunes.map(e => e.cantidad),
                            backgroundColor: '#5231F0'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // ============== ESTUDIANTES ==============
        async function cargarEstudiantes() {
            try {
                const response = await fetch(`${API_URL}/estudiantes`);
                const estudiantes = await response.json();
                
                const select = document.getElementById('filtroEstudiante');
                select.innerHTML = '<option value="">Todos los estudiantes</option>';
                
                estudiantes.forEach(est => {
                    const option = document.createElement('option');
                    option.value = est.id;
                    option.textContent = `${est.nombre} (${est.total_sesiones} sesiones)`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando estudiantes:', error);
            }
        }

        // ============== SESIONES ==============
        async function cargarSesiones() {
            const loading = document.getElementById('loadingSesiones');
            loading.classList.add('active');
            
            try {
                const estudianteId = document.getElementById('filtroEstudiante').value;
                const completada = document.getElementById('filtroEstado').value;
                
                let url = `${API_URL}/sesiones?limit=50`;
                if (estudianteId) url += `&estudiante_id=${estudianteId}`;
                if (completada) url += `&completada=${completada}`;
                
                const response = await fetch(url);
                const sesiones = await response.json();
                
                const tbody = document.getElementById('tablaSesiones');
                tbody.innerHTML = '';
                
                if (sesiones.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay sesiones registradas</td></tr>';
                    return;
                }
                
                sesiones.forEach(sesion => {
                    const fecha = new Date(sesion.fecha_inicio).toLocaleDateString('es-ES', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                    
                    const estado = sesion.completada 
                        ? '<span class="badge bg-success">Completada</span>'
                        : '<span class="badge bg-warning text-dark">En progreso</span>';
                    
                    const datosBtn = sesion.datos_suficientes
                        ? `<button class="btn btn-sm btn-primary" onclick="verMetricas(${sesion.id})">
                               <i class="bi bi-graph-up"></i> Ver métricas
                           </button>`
                        : `<button class="btn btn-sm btn-outline-secondary" onclick="verMetricas(${sesion.id})" title="Aciertos: ${sesion.aciertos}, Errores: ${sesion.errores} - Sin intentos registrados en BD">
                               <i class="bi bi-eye"></i> Ver parcial
                           </button>`;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${sesion.id}</td>
                            <td>${sesion.estudiante_nombre}</td>
                            <td>${fecha}</td>
                            <td><span class="badge bg-success">${sesion.aciertos}</span></td>
                            <td><span class="badge bg-danger">${sesion.errores}</span></td>
                            <td>${estado}</td>
                            <td>${datosBtn}</td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error cargando sesiones:', error);
                document.getElementById('tablaSesiones').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error al cargar sesiones</td></tr>';
            } finally {
                loading.classList.remove('active');
            }
        }

        // ============== MÉTRICAS DETALLADAS ==============
        async function verMetricas(sesionId) {
            sesionActual = sesionId;
            document.getElementById('metricaSesionId').textContent = sesionId;
            
            const modal = new bootstrap.Modal(document.getElementById('modalMetricas'));
            modal.show();
            
            document.getElementById('loadingMetricas').classList.add('active');
            document.getElementById('contenidoMetricas').style.display = 'none';
            document.getElementById('btnExportarJSON').disabled = true;
            document.getElementById('btnExportarCSV').disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/sesiones/${sesionId}/metricas`);
                const metricas = await response.json();
                
                renderizarMetricas(metricas);
                
                // Habilitar exportación si hay datos suficientes
                if (metricas.datos_suficientes) {
                    document.getElementById('btnExportarJSON').disabled = false;
                    document.getElementById('btnExportarCSV').disabled = false;
                    
                    document.getElementById('btnExportarJSON').onclick = () => exportarMetricas(sesionId, 'json');
                    document.getElementById('btnExportarCSV').onclick = () => exportarMetricas(sesionId, 'csv');
                }
            } catch (error) {
                console.error('Error cargando métricas:', error);
                document.getElementById('contenidoMetricas').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar las métricas
                    </div>
                `;
                document.getElementById('contenidoMetricas').style.display = 'block';
            } finally {
                document.getElementById('loadingMetricas').classList.remove('active');
            }
        }

        function renderizarMetricas(m) {
            const contenido = document.getElementById('contenidoMetricas');
            
            const tasaPorcentaje = (m.tasa_aciertos * 100).toFixed(1);
            const duracionMin = (m.duracion_segundos / 60).toFixed(1);
            
            // Errores por tipo
            let erroresHtml = '';
            for (const [tipo, data] of Object.entries(m.errores_por_tipo)) {
                const tipoLabel = {
                    'confusion': 'Confusión',
                    'tiempo_agotado': 'Tiempo agotado',
                    'distractor': 'Distractor'
                }[tipo] || tipo;
                
                erroresHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-exclamation-circle text-danger"></i> ${tipoLabel}</span>
                        <span class="badge bg-danger">${data.cantidad}</span>
                    </div>
                `;
            }
            if (!erroresHtml) erroresHtml = '<p class="text-muted">Sin errores registrados</p>';
            
            // Tiempos por señal
            let tiemposHtml = '';
            for (const [senal, data] of Object.entries(m.tiempos_por_senal)) {
                const tasaSenal = data.aciertos / (data.aciertos + data.errores) * 100;
                tiemposHtml += `
                    <tr>
                        <td>${senal}</td>
                        <td>${data.tiempo_promedio.toFixed(2)}s</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: ${tasaSenal}%">${data.aciertos}</div>
                                <div class="progress-bar bg-danger" style="width: ${100-tasaSenal}%">${data.errores}</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            // Historial de ajustes
            let ajustesHtml = '';
            m.ajustes_dificultad.forEach(a => {
                const fecha = new Date(a.timestamp).toLocaleTimeString('es-ES');
                ajustesHtml += `
                    <tr>
                        <td><span class="badge badge-${a.de.toLowerCase()}">${a.de}</span></td>
                        <td><i class="bi bi-arrow-right"></i></td>
                        <td><span class="badge badge-${a.a.toLowerCase()}">${a.a}</span></td>
                        <td>${a.motivo}</td>
                        <td>${(a.tasa_aciertos * 100).toFixed(0)}%</td>
                        <td>${fecha}</td>
                    </tr>
                `;
            });
            if (!ajustesHtml) ajustesHtml = '<tr><td colspan="6" class="text-center text-muted">Sin ajustes</td></tr>';
            
            // Aviso de datos insuficientes
            const totalIntentos = m.total_aciertos + m.total_errores;
            const avisoInsuficiente = totalIntentos === 0 ? `
                <div class="alert alert-warning mb-4">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Sesión sin intentos registrados.</strong> 
                    No se realizaron intentos durante esta sesión.
                </div>
            ` : '';
            
            contenido.innerHTML = `
                ${avisoInsuficiente}
                
                <!-- Resumen -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="metric-highlight text-center">
                            <h3 class="text-success">${m.total_aciertos}</h3>
                            <small>Aciertos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-highlight text-center">
                            <h3 class="text-danger">${m.total_errores}</h3>
                            <small>Errores</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-highlight text-center">
                            <h3 class="text-primary">${tasaPorcentaje}%</h3>
                            <small>Tasa de Aciertos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-highlight text-center">
                            <h3 class="text-info">${m.tiempo_promedio_respuesta}s</h3>
                            <small>Tiempo Promedio</small>
                        </div>
                    </div>
                </div>
                
                <!-- Info adicional -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>Estudiante:</strong> ${m.estudiante_nombre}</p>
                        <p><strong>Duración:</strong> ${duracionMin} minutos</p>
                        <p><strong>Zonas completadas:</strong> ${m.zonas_completadas}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Dificultad inicial:</strong> <span class="badge badge-${m.dificultad_inicial.toLowerCase()}">${m.dificultad_inicial}</span></p>
                        <p><strong>Dificultad final:</strong> <span class="badge badge-${m.dificultad_final.toLowerCase()}">${m.dificultad_final}</span></p>
                        <p><strong>Estado:</strong> ${m.completada ? '<span class="badge bg-success">Completada</span>' : '<span class="badge bg-warning">En progreso</span>'}</p>
                    </div>
                </div>
                
                <!-- Errores por tipo -->
                <div class="card mb-4">
                    <div class="card-header"><i class="bi bi-bug"></i> Errores por Tipo</div>
                    <div class="card-body">${erroresHtml}</div>
                </div>
                
                <!-- Tiempos por señal -->
                <div class="card mb-4">
                    <div class="card-header"><i class="bi bi-stopwatch"></i> Desempeño por Señal</div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Señal</th>
                                    <th>Tiempo Prom.</th>
                                    <th>Aciertos / Errores</th>
                                </tr>
                            </thead>
                            <tbody>${tiemposHtml || '<tr><td colspan="3" class="text-muted">Sin datos</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Historial de ajustes -->
                <div class="card">
                    <div class="card-header"><i class="bi bi-sliders"></i> Historial de Ajustes de Dificultad (IA)</div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>De</th>
                                    <th></th>
                                    <th>A</th>
                                    <th>Motivo</th>
                                    <th>Tasa</th>
                                    <th>Hora</th>
                                </tr>
                            </thead>
                            <tbody>${ajustesHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
            
            contenido.style.display = 'block';
        }

        function exportarMetricas(sesionId, formato) {
            window.open(`${API_URL}/sesiones/${sesionId}/exportar?formato=${formato}`, '_blank');
        }

        // ============== CONFIGURACIÓN ==============
        async function cargarConfiguracion() {
            const loading = document.getElementById('loadingConfig');
            const form = document.getElementById('formConfiguracion');
            
            loading.classList.add('active');
            form.style.display = 'none';
            
            try {
                const response = await fetch(`${API_URL}/configuracion`);
                const config = await response.json();
                
                document.getElementById('senales_baja').value = config.senales_dificultad_baja;
                document.getElementById('senales_media').value = config.senales_dificultad_media;
                document.getElementById('senales_alta').value = config.senales_dificultad_alta;
                
                document.getElementById('tiempo_baja').value = config.tiempo_dificultad_baja;
                document.getElementById('tiempo_media').value = config.tiempo_dificultad_media;
                document.getElementById('tiempo_alta').value = config.tiempo_dificultad_alta;
                
                document.getElementById('dificultad_inicial').value = config.dificultad_inicial;
                document.getElementById('rondas_zona').value = config.rondas_por_zona;
                document.getElementById('rondas_minimas').value = config.rondas_minimas_para_completar || 4;
                document.getElementById('tasa_minima').value = config.tasa_aciertos_minima;
                
                document.getElementById('usar_ml').checked = config.usar_modelo_ml !== false;
                document.getElementById('url_ml').value = config.url_servidor_ml || 'http://127.0.0.1:8000';
                
                // Verificar estado del modelo ML
                verificarEstadoML(config.url_servidor_ml || 'http://127.0.0.1:8000');
                
                form.style.display = 'block';
            } catch (error) {
                console.error('Error cargando configuración:', error);
                form.innerHTML = '<div class="alert alert-danger">Error al cargar la configuración</div>';
                form.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function guardarConfiguracion(e) {
            e.preventDefault();
            
            const erroresDiv = document.getElementById('erroresValidacion');
            const listaErrores = document.getElementById('listaErrores');
            erroresDiv.style.display = 'none';
            listaErrores.innerHTML = '';
            
            const datos = {
                senales_dificultad_baja: parseInt(document.getElementById('senales_baja').value),
                senales_dificultad_media: parseInt(document.getElementById('senales_media').value),
                senales_dificultad_alta: parseInt(document.getElementById('senales_alta').value),
                tiempo_dificultad_baja: parseFloat(document.getElementById('tiempo_baja').value),
                tiempo_dificultad_media: parseFloat(document.getElementById('tiempo_media').value),
                tiempo_dificultad_alta: parseFloat(document.getElementById('tiempo_alta').value),
                dificultad_inicial: parseInt(document.getElementById('dificultad_inicial').value),
                rondas_por_zona: parseInt(document.getElementById('rondas_zona').value),
                rondas_minimas_para_completar: parseInt(document.getElementById('rondas_minimas').value),
                tasa_aciertos_minima: parseFloat(document.getElementById('tasa_minima').value),
                usar_modelo_ml: document.getElementById('usar_ml').checked,
                url_servidor_ml: document.getElementById('url_ml').value
            };
            
            try {
                const response = await fetch(`${API_URL}/configuracion`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                
                if (response.ok) {
                    alert('✅ Configuración guardada exitosamente');
                } else {
                    const error = await response.json();
                    
                    if (error.detail && error.detail.errores) {
                        erroresDiv.style.display = 'block';
                        error.detail.errores.forEach(err => {
                            const li = document.createElement('li');
                            li.textContent = err;
                            listaErrores.appendChild(li);
                        });
                    } else {
                        alert('❌ Error: ' + (error.detail || 'Error desconocido'));
                    }
                }
            } catch (error) {
                console.error('Error guardando configuración:', error);
                alert('❌ Error de conexión al guardar');
            }
        }
    </script>
</body>
</html>
